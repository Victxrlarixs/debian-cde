---
import WindowControls from '../../common/WindowControls.astro';

const XPM_BACKDROPS = [
  // Stone & Marble
  { name: 'Marble',       file: 'Marble.pm' },
  { name: 'Rocks',        file: 'Rocks.pm' },
  { name: 'Fossil',       file: 'Fossil.pm' },
  { name: 'Pebbles',      file: 'Pebbles.pm' },
  { name: 'K2',           file: 'K2.pm' },
  // Wood & Fabric
  { name: 'Burl',         file: 'Burl.pm' },
  { name: 'Canvas',       file: 'Canvas.pm' },
  { name: 'Cotton',       file: 'Cotton.pm' },
  { name: 'Corduroy',     file: 'Corduroy.pm' },
  { name: 'Linen',        file: 'Linen.pm' },
  { name: 'Leather',      file: 'Leather.pm' },
  { name: 'Tartan',       file: 'Tartan.pm' },
  { name: 'Parquet',      file: 'Parquet.pm' },
  // Natural
  { name: 'Sand Dark',    file: 'SandDark.pm' },
  { name: 'Sand Light',   file: 'SandLight.pm' },
  { name: 'Dune',         file: 'Dune.pm' },
  { name: 'Wave',         file: 'Wave.pm' },
  { name: 'Rain',         file: 'Rain.pm' },
  { name: 'Water Drops',  file: 'WaterDrops.pm' },
  { name: 'Rice Paper',   file: 'RicePaper.pm' },
  // Sky & Space
  { name: 'Sky Dark',     file: 'SkyDark.pm' },
  { name: 'Sky Light',    file: 'SkyLight.pm' },
  { name: 'Space',        file: 'Space.pm' },
  // Geometric
  { name: 'Cubes',        file: 'Cubes.pm' },
  { name: 'Brick Wall',   file: 'BrickWall.pm' },
  { name: 'Rivets',       file: 'Rivets.pm' },
  { name: 'Maze',         file: 'Maze.pm' },
  { name: 'Structure',    file: 'Structure.pm' },
  { name: 'Greece',       file: 'Greece.pm' },
  { name: 'Celtic',       file: 'Celtic.pm' },
  // Industrial / Retro
  { name: 'Circuit',      file: 'CircuitBoards.pm' },
  { name: 'Memphis',      file: 'Memphis.pm' },
  { name: 'Noise',        file: 'Noise.pm' },
  { name: 'Old Paper',    file: 'OldPaper.pm' },
  { name: 'Stix',         file: 'Stix.pm' },
  { name: 'Ebony',        file: 'Ebony.pm' },
  // Special CDE
  { name: 'Toronto',      file: 'Toronto.pm' },
  { name: 'Southwest',    file: 'Southwest.pm' },
  { name: 'Fibre',        file: 'Fibre.pm' },
  { name: 'Snake Skin',   file: 'SnakeLeather.pm' },
];
---

<div class="cde-retro-modal" id="styleManagerBackdrop">
  <div class="titlebar" id="styleManagerBackdropTitlebar">
    <span class="titlebar-text">Style Manager - Backdrop</span>
    <WindowControls windowId="styleManagerBackdrop" closeFunction="styleManager.closeBackdrop" />
  </div>

  <div class="modal-body backdrop-modal-body">
    <p class="backdrop-section-label">Classic CDE Patterns</p>
    <div class="backdrop-grid" id="backdropXpmGrid">
      {XPM_BACKDROPS.map((bd) => (
        <button
          class="backdrop-preset"
          data-type="xpm"
          data-value={`/backdrops/${bd.file}`}
          onclick={`styleManager.backdrop.update('xpm', '/backdrops/${bd.file}'); styleManager.backdrop.syncUI()`}
          title={bd.name}
        >
          <canvas
            class="backdrop-preview-canvas"
            data-xpm={`/backdrops/${bd.file}`}
            width="48"
            height="36"
          ></canvas>
          <span class="backdrop-label">{bd.name}</span>
        </button>
      ))}
    </div>
  </div>

  <div class="cde-statusbar">
    <div class="cde-statusleft">Backdrop</div>
    <div class="cde-statusright" id="backdropStatus">Ready</div>
  </div>

  <div class="cde-actionbar">
    <button class="cde-btn cde-btn-default" onclick="styleManager.closeBackdrop()">OK</button>
    <button class="cde-btn" onclick="styleManager.closeBackdrop()">Cancel</button>
    <button class="cde-btn" onclick="styleManager.showMessage('Help not implemented')">Help</button>
  </div>
</div>

<script>
  import { parseXpmToDataUrl } from '../../../scripts/core/xpmparser';

  async function renderXpmThumbnails() {
    const canvases = document.querySelectorAll<HTMLCanvasElement>('.backdrop-preview-canvas[data-xpm]');
    for (const canvas of canvases) {
      if (canvas.dataset.rendered) continue;
      const path = canvas.dataset.xpm!;
      try {
        const res = await fetch(path);
        if (!res.ok) continue;
        const text = await res.text();
        const dataUrl = await parseXpmToDataUrl(text);
        if (dataUrl) {
          const img = new Image();
          img.onload = () => {
            const ctx = canvas.getContext('2d');
            if (ctx) {
              const pat = ctx.createPattern(img, 'repeat');
              if (pat) {
                ctx.fillStyle = pat;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
              }
            }
          };
          img.src = dataUrl;
          canvas.dataset.rendered = '1';
        }
      } catch {
        // silent fail for thumbnail
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('styleManagerBackdrop');
    if (!modal) return;
    const observer = new MutationObserver(() => {
      if (modal.offsetParent !== null) {
        renderXpmThumbnails();
      }
    });
    observer.observe(modal, { attributes: true, attributeFilter: ['style', 'class'] });
    // Also try on first load if already visible
    if (modal.offsetParent !== null) renderXpmThumbnails();
  });
</script>
